name: Calibre News Conversion
run-name: 'Calibre News Conversion: ${{ github.ref_name }}'

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œ

permissions:
  contents: write  # å¢åŠ å†™å…¥æƒé™ä»¥ä¾¿æ¨é€æ›´æ”¹

jobs:
  converter:
    runs-on: ubuntu-latest
    env:
      output_dir: converted_ebooks
      publisher: bookfere.com
      author: Calibre News Delivery
      ext: ${{ secrets.FORMAT || 'epub' }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean Previous Run
        run: |
          echo "ğŸ§¹ Cleaning previous conversion results..."
          # åˆ é™¤æ—§çš„è¾“å‡ºç›®å½•å’Œæ ¹ç›®å½•çš„ç”µå­ä¹¦
          rm -rf ${{ env.output_dir }} 
          find . -maxdepth 1 -name -name "*.${{ env.ext }}" -delete 2>/dev/null || true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install Calibre
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1 libopengl0 libxcb-cursor0
          sudo -v && wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sudo sh /dev/stdin
      
      - name: Find Available Recipes
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰ recipe æ–‡ä»¶
          find . -name "*.recipe" -type f > recipe_list.txt
          
          if [ ! -s recipe_list.txt ]; then
            echo "âŒ No recipe files found"
            exit 1
          fi
          
          echo "ğŸ“‹ Found $(wc -l < recipe_list.txt) recipes:"
          cat recipe_list.txt
      
      - name: Convert Recipes to Ebooks
        run: |
          mkdir -p $output_dir
          total_success=0
          
                   
          while IFS= read -r recipe_file; do
            [ -z "$recipe_file" ] && continue
            
            base_name=$(basename "$recipe_file" .recipe)
            output_file="${base_name}.${ext}"
          
          echo "ğŸ”„ Converting: $recipe_file"
          
          # å‡†å¤‡è½¬æ¢å‚æ•°
          args="--authors='$author' --publisher='$publisher'"
          
          # æ·»åŠ å°é¢ï¼ˆå¦‚æœæœ‰ï¼‰
          if [ -f "covers/${base_name}.png" ]; then
              args="$args --cover='covers/${base_name}.png'"
          fi
          
          # æ‰§è¡Œè½¬æ¢
          if eval ebook-convert "'$recipe_file'" "'$output_file'" $args; then
              # å¤åˆ¶åˆ°è¾“å‡ºç›®å½•å¤‡ä»½
              cp "$output_file" "$output_dir/"
              echo "âœ… Success: $output_file"
              ((total_success++))
          else
              echo "âŒ Failed: $recipe_file"
          fi
          
          done < recipe_list.txt
          
          echo "ğŸ“Š Conversion complete: $total_success ebooks generated"
          
          if [ $total_success -eq 0 ]; then
              echo "âš ï¸ No ebooks were produced"
          fi
      
      - name: Commit and Push Ebooks to Repository
        run: |
          echo "ğŸš€ Committing new ebooks to repository..."
          
          # é…ç½® git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æŸ¥çœ‹å½“å‰çŠ¶æ€
          echo "Current changes:"
          git status
          
          # æ·»åŠ æ–°å»ºçš„ç”µå­ä¹¦æ–‡ä»¶
          git add *."${ext}" 2>/dev/null || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¯æäº¤çš„å†…å®¹
          if git diff-index --quiet HEAD --; then
            echo "ğŸ“ No new ebooks to commit"
          else
            # æäº¤æ›´æ”¹
            git commit -m "Add newly converted ebooks - $(date '+%Y-%m-%d %H:%M')"
          fi
          
          # å¼ºåˆ¶æ¨é€æ›´æ”¹
          git push origin HEAD:${{ github.ref_name }} || echo "Push may have failed but workflow continues"
      
      - name: Show Final Results
        run: |
          echo "ğŸ‰ Final Results:"
          echo "Root directory ebooks:"
          ls -la *."${ext}" 2>/dev/null || echo "No ebooks in root directory"
      
      - name: Upload Artifact for Manual Download
        uses: actions/upload-artifact@v4
        with:
          name: News-Ebooks-${{ github.run_number }}
          path: "*.${ {env.ext}}}"
          retention-days: 7
      
      - name: Create Summary Report
        run: |
          echo "# ğŸ“š Calibre News Conversion Report" > conversion_summary.md
          echo "" >> conversion_summary.md
          echo "**Run Number:** ${{ github.run_number }}" >> conversion_summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> conversion_summary.md
          echo "**Trigger:** ${{ github.event_name }}" >> conversion-directory.md
          echo "**Date:** $(date)" >> conversion_summary.md
          echo "" >> conversion_summary.md
          echo "## Generated Files:" >> conversion_summary.md
          ls -1 *."${ext}" 2>/dev/null | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "- $file ($size)" >> conversion_summary.md
